<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IMM Dates 1970 to 2100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div id="form">
            <form id="formImmDate">
                <div class="mb-3">
                    <label for="dateInput" class="form-label">Date in yyyyMMdd:</label>
                    <input type="text" class="form-control" id="dateInput" placeholder="yyyyMMdd">
                    <button type="submit" class="btn btn-primary" class="form-control" id="btnSubmit">Get IMM
                        Dates</button>
                    <label id="dateInputValidationError" class="form-label">Please enter valid date</label>
                </div>
            </form>
        </div>
        <div>
            <a href="#" id="hrefExportToExcel" class="export">Export Table data into Excel</a>
        </div>
        <div id="dvData">
            <table id="tblImmDate" class="table table-bordered border-primary">
                <thead>
                    <tr>
                        <th>upcoming IMM Date</th>
                        <th>Position</th>
                        <th>Maturity/Termination - When?</th>
                        <th>Calendar</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

</body>
<script src="./data/immDates.json"></script>
<script type="text/javascript">
    const immDatesAll = [];
    $().ready(function () {
        // $( "p" ).text( "The DOM is now loaded and can be manipulated." );
        console.log("load the data here...only once forever!");
        // $('#dateInputValidationError').hide();
        //TODO: generate IMM Date from 1970 to 2100
        $.getJSON("data/immDates.json", function (result) {
            $.each(result, function (i, field) {
                // $("div").append(field + " ");
                // console.log(`i: ${i} field: ${field}`);
                //create labels for dates
                // const userDate = Number.parseInt($('#dateInput').val(), 10);
                // const immDate = Number.parseInt(field, 10);
                // console.log('immDate..' + immDate);
                // console.log('userDate..' + userDate);
                // if (immDate >= userDate) {

                immDatesAll.push(Number.parseInt(field, 10));
                // console.log('..' + immDatesAll);
                // }
                // const immMaturityLabel = getLabelForThePosition(i);
                // dateWithLabel.push([field, i])
                //render date and labels
                // dataToTableRow(field, i + 1, immMaturityLabel);
            });
        });
        console.log("loaded the data here!");
    });

    $("#formImmDate").submit(function (event) {
        doWork();
        event.preventDefault();
    });
    function exportTableToCSV($table, filename) {

        var $rows = $table.find('tr:has(td)'),

            // Temporary delimiter characters unlikely to be typed by keyboard
            // This is to avoid accidentally splitting the actual contents
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character

            // actual delimiter characters for CSV format
            colDelim = '","',
            rowDelim = '"\r\n"',
            header = "upcoming IMM Date,Position,Maturity/Termination - When?" + "\r\n"

        // Grab text from table into CSV formatted string
        csv = header + '"' + $rows.map(function (i, row) {
            var $row = $(row),
                $cols = $row.find('td');

            return $cols.map(function (j, col) {
                var $col = $(col),
                    text = $col.text();

                return text.replace(/"/g, '""'); // escape double quotes

            }).get().join(tmpColDelim);

        }).get().join(tmpRowDelim)
            .split(tmpRowDelim).join(rowDelim)
            .split(tmpColDelim).join(colDelim) + '"';

        // Deliberate 'false', see comment below
        if (false && window.navigator.msSaveBlob) {

            var blob = new Blob([decodeURIComponent(csv)], {
                type: 'text/csv;charset=utf8'
            });

            // Crashes in IE 10, IE 11 and Microsoft Edge
            // See MS Edge Issue #10396033
            // Hence, the deliberate 'false'
            // This is here just for completeness
            // Remove the 'false' at your own risk
            window.navigator.msSaveBlob(blob, filename);

        } else if (window.Blob && window.URL) {
            // HTML5 Blob        
            var blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8'
            });
            var csvUrl = URL.createObjectURL(blob);

            // console.log('filename...' + filename);
            $(this)
                .attr({
                    'download': filename,
                    'href': csvUrl
                });
        } else {
            // Data URI
            var csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

            $(this)
                .attr({
                    'download': filename,
                    'href': csvData,
                    'target': '_blank'
                });
        }
    }


    function getLabelForThePosition(index) {
        let label = "Don't know";
        if (index === 0) {
            label = '3 months'
        }
        if (index === 1) {
            label = '6 months'
        }
        if (index === 2) {
            label = '9 months'
        }
        if ((index + 1) % 4 === 0) {
            const year = (index + 1) / 4;
            const yearText = year === 1 ? 'year' : 'years'
            label = year + ' ' + yearText;
        }
        return label;

    }
    function validateDate() {
        let isValid = false;
        const userValue = $('#dateInput').val();
        // console.log('userValue...' + userValue);
        if (userValue && userValue.length > 0 && userValue.length === 8) {
            isValid = true;
        }
        return isValid;
    }
    function getImmDatesForGivenDate(date) {
        const userDate = Number.parseInt(date, 10);
        const immDates = immDatesAll.filter(function (immDate, index, array) {
            if (immDate >= userDate) {
                return true;
            }
        })
        // const immDate = Number.parseInt(field, 10);
        // console.log('immDate..' + immDate);
        // console.log('userDate..' + userDate);
        // // if (immDate >= userDate) {

        // immDatesAll.push(immDate);
        // console.log('..' + immDatesAll);
        return immDates;
    }
    function doWork() {
        $("#tblImmDate > tbody > tr").remove();
        $(".export").off("click");
        // $(".export").off("click", "#hrefExportToExcel", function () {
        //     console.log('No data available!')
        // });

        if (validateDate()) {
            $('#dateInputValidationError').hide();

            const immDatesForGivenDate = getImmDatesForGivenDate($('#dateInput').val());
            // console.log('immDatesForGivenDate...' + immDatesForGivenDate);
            immDatesForGivenDate.forEach(function (value, index, array) {
                const immMaturityLabel = getLabelForThePosition(index);
                dataToTableRow(value, index + 1, immMaturityLabel);
            });
            // This must be a hyperlink
            $(".export").on('click', function (event) {
                if ($('#dateInput').val() && validateDate()) {
                    var args = [$('#dvData>table'), 'IMM-Dates-From-' + $('#dateInput').val()];
                    exportTableToCSV.apply(this, args);
                }
            });

        } else {
            $('#dateInput').focus();
            $('#dateInputValidationError').show();
            $(".export").off("click");
            // $(".export").off("click", "#hrefExportToExcel");
            // $(".export").off("click", "#hrefExportToExcel", function () {
            //     console.log('No data available!')
            // });
        }
    }
    function getDateInISO8601Format(date) {
        const inputDate = date + '';
        const formattedDate = `${inputDate.substring(0, 4)}-${inputDate.substring(4, 6)}-${inputDate.substring(6, 8)}`;
        // console.log('1...' + inputDate);
        return formattedDate;
    }
    function dataToTableRow(date, position, immLabel) {
        const calendar = `<input
                            type='date'
                            id='calendar_${date}'
                            name='calendar'
                            value='${getDateInISO8601Format(date)}' />`;
        // console.log(calendar);
        let tr = `<tr>
                    <td>${date}</td>
                    <td>${position}</td>
                    <td>${immLabel}</td>
                    <td>${calendar}</td>
                </tr>`
        $('#tblImmDate > tbody:last-child').append(tr);
    }
    // function doExport() {
    //     exportTableToCSV($('#dvData>table'),"IMM-From-" + "20220904" + '.csv' )
    //     alert("exported!");
    // }
    function addRow(tableID) {
        // Get a reference to the table
        let tableRef = document.getElementById(tableID);

        // Insert a row at the end of the table
        let newRow = tableRef.insertRow(-1);

        // Insert a cell in the row at index 0
        let newCell = newRow.insertCell(-1);

        // Append a text node to the cell
        let newText = document.createTextNode('2022-09-21');
        newCell.appendChild(newText); //date

        let thirdCell = newRow.insertCell(-1);
        let thirdCellContent = document.createTextNode('3 month tenor');
        thirdCell.appendChild(thirdCellContent); //date

        let secondCell = newRow.insertCell(-1);
        // let cellContent = document.createTextNode('cell 2');
        let input = document.createElement("input");
        // input type="date" id="start" name="trip-start"       value="2018-07-22"
        input.setAttribute('type', 'date');
        input.setAttribute('id', 'immDate1');
        input.setAttribute('value', '2022-09-21');
        secondCell.appendChild(input); //label for the date
    }
</script>

</html>